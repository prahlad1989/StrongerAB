<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>Influencers</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- site icons -->
       <link rel="icon" href="https://www.strongerlabel.com/favicon.ico?stronger" type="image/x-icon" />
      <!-- bootstrap css -->
      <link rel="stylesheet" href="static/css/bootstrap.min.css" />
      <!-- site css -->
      <link rel="stylesheet" href="static/css/style.css" />
      <link rel="stylesheet" href="https://forni.se/wp-content/themes/sw_new_forni_theme/css/crm.css" />
      <!-- responsive css -->
      <link rel="stylesheet" href="static/css/responsive.css" />
      <!-- colors css -->
      <link rel="stylesheet" href="static/css/colors.css" />
      <!-- wow animation css -->
      <link rel="stylesheet" href="static/css/animate.css" />
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <script src="../js/jquery.stickytableheaders.js" type="text/javascript"></script>
      <![endif]-->
   </head>

   <body id="default_theme" class="home_page1" >
   <script>
       var is_user_staff='{{ is_user_staff }}'=='True';
       var influencerFieldsDict = {{ influencerFieldsDict |safe }};
       var dropDownFunction = function(x){return {Name:x.trim()}} ;
       var list_of_countries = '{{ list_of_countries }}'
       list_of_countries = list_of_countries.split(",").map(dropDownFunction);
       var collections = '{{collections}}'
       collections = collections.split(",").map(dropDownFunction);
       var channels = '{{channels}}'
       //console.log(channels);
       channels = channels.split(",").map(dropDownFunction);
       //console.log(channels);
       var influencer_post_status = {{ influencer_post_status| safe }}
       influencer_post_status = influencer_post_status.map(dropDownFunction);
       var paid_unpaid_choices = {{ paid_unpaid_choices| safe }}
       //console.log(paid_unpaid_choices);
       paid_unpaid_choices = paid_unpaid_choices.map(dropDownFunction);
       //console.log(paid_unpaid_choices);
       var influencerOrProspectItems = {{ is_influencer_choices|safe }}
       influencerOrProspectItems = influencerOrProspectItems.map(function(x){
         if(x == 'PR_') return {Name:'PR',Value:'PR_'};
         else return {Name:x,Value:x};
       });
       var is_answered_choices = {{ is_answered_choices |safe }};
       var influencer_mandatory_fields = {{ influencer_mandatory_fields|safe }};
       var influencerFieldsList = {{ influencerFieldsList|safe }}
       //console.log(influencerFieldsList);
       influencerFieldsList = influencerFieldsList.map(dropDownFunction);
       is_answered_choices = is_answered_choices.map(dropDownFunction);
       //console.log("influencer_post_status "+influencer_post_status);
       var influe_field_preferences = {{ influe_field_preferences | safe }};
       var users = {{ users |safe}};
       function loadGrid($grid){
          $grid.jsGrid("option","pageIndex",1);
          $grid.jsGrid("loadData");
       }
       var isColumnVisible = function(column_name){
                var previousSelectedFields = influe_field_preferences.map((x)=>x.Name);
                if(previousSelectedFields.length == 0){
                    return true;
                }
                else if (influencer_mandatory_fields.indexOf(column_name) != -1 || previousSelectedFields.indexOf(column_name) != -1){
                    return true;
                }
                else return false;
            }

   </script>
      <!-- header -->
      <header class="header header_style1">
         <div class="container">
            <div class="row">
               <div class="col-md-9 col-lg-10" style="max-height:160px">
                  <div class="logo"><a href="/"><img src="static/images/influencer_logo.png" alt="#" /></a></div>
                  <div class="main_menu float-right">
                     <div class="menu">
                        <ul class="clearfix">
                           <li class="active"><a href="#all_influencers">Influencers</a></li>
                            <li><a href="reports" target="_blank">Reports</a></li>
                           <li><a href="#importFunction">Upload</a></li>
                           <li><a href="admin" target="_blank">Admin</a></li>
                           <li><a href="change-password">Change Pwd</a></li>
                           <li><a href="logout">LogOut</a></li>
                           <li>Hi {{first_name}}</li>

                        </ul>
                     </div>
                  </div>

               </div>
               <!--<div class="col-md-3 col-lg-2">
                  <div class="right_bt"><div class="bt_main" href="index.html">Prahlad/LogOut</div> </div>
               </div>-->
            </div>
         </div>
      </header>
      <!-- section -->
      <section class="layout_padding layer_style" id="all_influencers">

         <!--<div id="jsGrid3" ></div>-->
         <button id="configureColumns" name="configureColumns">Configure Columns</button>
         <script>

         </script>
         <div class="modal" tabindex="-1" role="dialog" id="myModal" style="display:none;">
           <div class="modal-dialog" role="document">
             <div class="modal-content">
               <div class="modal-header">
                 <h5 class="modal-title">Select the columns to be displayed</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                   <span aria-hidden="true">&times;</span>
                 </button>
               </div>
               <div class="modal-body" id="myModal_body">
               </div>
<!--               <div class="modal-footer">-->
<!--                 <button type="button" class="btn btn-primary">Save changes</button>-->
<!--                 <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->
<!--               </div>-->
             </div>
           </div>
         </div>


         <br><br>
         <div id="jsGridInfluencers"></div>

      </section>

      <section class="layout_padding layer_style" id="importFunction">

         <!--<div id="jsGrid3" ></div>-->
         <br><br>
         <div class="container text_align_center" >
            <div class="notice">Please upload csv file with the format similar to <a href="https://docs.google.com/spreadsheets/d/1YOWGGTQytCGnUJzWrpvG6A4a6CFYbiGh26TTR65Vj2E/edit#gid=300405385" target="_blank">here</a></div>
            <br>
            <div name="uploads">

               <form action="influencers" id="influencers" method="post" enctype="multipart/form-data">
                   <input type="file" id="myfile" name="myfile"/>
                   {% csrf_token %}
                   <br><br>
                   <input type="submit"   value="Upload">
               </form>
            </div>
         </div>
         <div class="container showUploading">
         </div>
      </section>
      <!-- jQuery (necessary for Bootstrap's JavaScript) -->
      <script src="static/js/jquery.min.js"></script>
      <script src="static/js/popper.min.js"></script>
      <script src="static/js/bootstrap.min.js"></script>
      <script src="static/js/owl.carousel.js"></script>
      <!-- wow animation -->
      <script src="static/js/wow.js"></script>

      <!-- custom js -->
      <script src="static/js/custom.js"></script>
       <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.2/themes/cupertino/jquery-ui.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>

      <script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/src/js/bootstrap-datetimepicker.js"></script>
      <link rel="stylesheet" type="text/css"
          href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/build/css/bootstrap-datetimepicker.css">
      <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
      <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>
      <script src="https://www.jqueryscript.net/demo/jQuery-Plugin-For-Sticky-Table-Header/js/jquery.stickytableheaders.js"></script>
      <link href="static/css/jquery.comiseo.daterangepicker.css" rel="stylesheet">
      <script type="text/javascript" src="static/js/jquery.comiseo.daterangepicker.js"></script>

     <script>

            $(function() {
                !is_user_staff && $("li a[href='admin']").hide();
                //console.log(influencerFieldsList);
                $("table").each(function(){$(this).stickyTableHeaders();});
                $("button[name='configureColumns']").on('click', function(e){
                    $("#myModal").css("display","block");
                });
                $("button.close").on('click',function(e){
                    $("#myModal").css("display","none");
                });
                db = influencerFieldsList.filter((x)=> x.Name != 'influencerbase ptr');
                //console.log("executed");
                var selectedItems = [];
                if(influe_field_preferences.length == 0){
                    selectedItems = db;
                }else{
                     selectedItems = $.merge([],influe_field_preferences);
                }


                var selectItem = function(item) {
                    selectedItems.push(item);
                };

                var unselectItem = function(item) {
                    selectedItems = $.grep(selectedItems, function(i) {
                        return i.Name != item.Name;
                    });
                };

                var savePreferences = function($element) {
                              method = "POST"
                              //if user prefs already exists, make a put call.
                              if(influe_field_preferences && influe_field_preferences.length > 0){
                                method = "PUT";
                              }
                              var data = selectedItems;
                              //console.log("selected ids {selectedItems}" );
                              return $.ajax({
                                     type: method,
                                     url: "influe_field_preferences",
                                     data: JSON.stringify(data),
                                     headers: {"X-CSRFToken": '{{ csrf_token }}', "content-type":"text/json"},
                                     error:function(response){
                                         if(response.responseJSON){
                                              alert(response.responseJSON.error+" "+response.statusText);
                                           }else{
                                              alert(response.statusText);
                                           }
                                         selectedItems = [];
                                     },
                                     success: function(response){
                                         //alert(response);
                                         selectedItems = [];
                                         $element.css("display","none");
                                         location.reload();
                                     }
                                 });

                          };

                $("#myModal_body").jsGrid({

                    width: "70%",
                    autoload: true,
                    confirmDeleting: false,
                    controller: {
                        loadData: function() {
                            return db;
                        }
                    },
                    fields: [
                        {
                            headerTemplate: function() {
                                return $("<button>").attr("type", "button").text("Save changes")
                                        .on("click", function () {
                                            savePreferences($("#myModal_body"));
                                        });
                            },
                            itemTemplate: function(_, item) {
                                if($.inArray(item.Name, influencer_mandatory_fields) > -1){
                                    return $("<input>").attr("type", "checkbox")
                                        .prop("checked", true)
                                        .prop("disabled",true)
                                }
                                else{
                                    return $("<input>").attr("type", "checkbox")
                                        .prop("checked", $.inArray(item.Name, selectedItems.map((x)=>x.Name)) > -1)
                                        .on("change", function () {
                                            $(this).is(":checked") ? selectItem(item) : unselectItem(item);
                                        });
                                }

                            },
                            align: "center",
                            width: 50
                        },
                        { name: "Name", type: "text", width: 150 },

                    ]
                });

            });

      $(function() {

            $( document ).on( 'focus', ':input', function(){
               $( this ).attr( 'autocomplete', 'false' );
            });

            $(document).on('click', function(event){
               !($(event.target).parents().hasClass("jsgrid")) && $("#jsGridInfluencers").jsGrid('cancelEdit');
            });
            var originalFilterTemplate = jsGrid.fields.text.prototype.filterTemplate;
                        //console.log(originalFilterTemplate);
            jsGrid.fields.text.prototype.filterTemplate = function() {
                        var grid = this._grid;
                        if(!this.filtering)
                           return originalFilterTemplate;
                        var $result = originalFilterTemplate.call(this);
                        $result.on("keyup", $.debounce(350, function(e){
                           grid.search();
                        }));
                        return $result;
                    }

            function MyDateField(config) {
            jsGrid.Field.call(this, config);
        };

            MyDateField.prototype = new jsGrid.Field({
                sorter: function(date1, date2) {
                    return new Date(date1) - new Date(date2);
                },
                _createDate: function($grid){
                    return  $("<input>").datepicker({
                    defaultDate: new Date(),
                    dateFormat: 'dd/mm/yy',
                    onSelect: function(dateText) {
                            $grid.search();
    }                }).prop("readonly", !!this.readOnly);
                },
                _searchDate: function($grid){
                  if(!this.filtering)
                    return "";
                  $input = $("<input>");
                  $div =  $("<div>").append($input);
                  $input.daterangepicker({
                    change:function(dateText) {
                            $grid.search();
                    },
                    clear:function(dateText) {
                            $grid.search();
                    },
                    datepickerOptions : {
                        numberOfMonths : 2
                    }

                  });
                  return $div;

                },
                filterTemplate: function() {
                  if(!this.filtering)
                    return "";
                  var grid = this._grid,
                  $result = this.filterControl = this._searchDate(this._grid);
                  return $result;

                },
            filterValue: function() {
                var range=this.filterControl.children().first().daterangepicker("getRange");
                if(range) {
                  range.start = (range.start.getTime())/1000;
                  range.end = (range.end.getTime())/1000;
                  return range;
                }
                return null;
            },

                itemTemplate: function(value) {
                    return value && new Date(value).toLocaleDateString();
                },
                insertTemplate: function(value) {
                    if(!this.inserting)
                        return "";
                    return this._insertPicker = $("<input>").datepicker({ defaultDate: new Date() });
                },
                editTemplate: function(value) {
                    if(!this.editing)
                        return this.itemTemplate.apply(this, arguments);
                     if(!value)return this._insertPicker = $("<input>").datepicker({ defaultDate: new Date() });
                     return this._editPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));
                },
                insertValue: function() {
                    var date=this._insertPicker.datepicker("getDate");
                    if(date) return date;
                    return null;
                },
                editValue: function() {
                    var date=this._editPicker && this._editPicker.datepicker("getDate");
                    if(date) return (date.getTime())/1000;
                    return null;
                }
            });

            jsGrid.fields.myDateField = MyDateField;

           /* function insert_on_enter(field) {
              field.on("keydown", function(e) {
                if(e.keyCode === 13) {
                  $("#jsGridInfluencers").jsGrid("insertItem");
                  return false;
                }
              });
            }

            function update_on_enter(field) {
              field.on("keydown", function(e) {
                if(e.keyCode === 13) {
                  $("#jsGridInfluencers").jsGrid("updateItem");
                  return false;
                }
              });
            } */

            var resultedFields = influe_field_preferences.length > 0 ? influencer_mandatory_fields.length+influe_field_preferences.length : influencerFieldsList.length;

            var jsGridWidth = Math.max(resultedFields*8,100)+"%";
            $("#jsGridInfluencers").jsGrid({
             width:jsGridWidth,
             inserting:true,
             editing:true,
             sorting:true,
             paging:true,
             pageSize:100,
             autoload: true,
             filtering:true,
             autoSearch:true,
             pageLoading: true,

             pagerFormat: "Pages: {first} {prev} {pages} {next} {last} &nbsp;&nbsp; {pageIndex} of {pageCount} &nbsp;&nbsp; Records Shown: {itemCount}",
             controller: {
             insertItem: function(item) {
                 var grid=this._grid;
                 return $.ajax({
                     type: "POST",
                     url: "influencer",
                     data: item,
                     headers:{"X-CSRFToken": '{{ csrf_token }}'},
                     error: function (response){
                          if(response.responseJSON){
                                alert(response.responseJSON.error+" "+response.statusText);
                           }else{
                            alert(response.statusText);
                          }
                     },
                     success: function(data){
                         loadGrid($("#jsGridInfluencers"));
                     }

                 });
             },

             deleteItem: function(item) {
                 var $grid = $(this);
                 return $.ajax({
                     type: "DELETE",
                     url: "influencer",
                     data: JSON.stringify(item),
                     headers: {"X-CSRFToken": '{{ csrf_token }}', "content-type":"text/json"},
                     error:function(data){
                         alert(data.responseJSON.error);
                     },
                     success: function(data){
                         alert("Deleted");
                     }
                 });
             },
             onItemInserted:function(args){
                 $("#jsGrid").jsGrid("loadData");
             }
             ,
             updateItem: function(item) {
                 return $.ajax({
                     type: "PUT",
                     url: "influencer",
                     data: JSON.stringify(item),
                     headers:{"X-CSRFToken": '{{ csrf_token }}',"content-type":"text/json"},
                     error:function(data){
                         if(!data.responseJSON){
                             alert(data.statusText);
                         }
                         else alert(data.responseJSON.error);
                     }
                 });
             },

             loadData: function(filter) {
                                 var d = $.Deferred();
                                 $.ajax({
                                     url: "influencers_query",
                                     dataType: "json",
                                     data:JSON.stringify(filter),
                                     method:"POST",
                                     headers:{"X-CSRFToken": '{{ csrf_token }}',"content-type":"text/json"},

                                 }).done(function(response) {
                                         var records=response.data;
                                         records.forEach(function(record,index){
                                             record.index = index+1;
                                         });
                                      d.resolve(response);
                                 }).fail(function(response){
                                    if(response.responseJSON){
                                       alert(response.responseJSON.error+" "+response.statusText);
                                    }else{
                                    alert(response.statusText);
                                    }

                                 });
                                 return d.promise();
                             }
                         },

             fields: [
                  {
                      headerTemplate: function() {
                          return $("<button>").attr("type", "button").text("Delete")
                                  .on("click", function () {
                                      deleteSelectedItems();
                                  });
                      },
                      itemTemplate: function(_, item) {
                          return $("<input>").attr("type", "checkbox")
                                  .prop("checked", $.inArray(item, selectedItems) > -1)
                                  .on("change", function () {
                                      $(this).is(":checked") ? selectItem(item) : unselectItem(item);
                                  });
                      },
                      align: "center",
                      editing:true,
                      width: 50,
                      sorting:false
                 },
                 {title: "Id", name: "id", type: "number", visible: false, inserting: false, editing: false },
                 {name: "is_influencer", title: influencerFieldsDict.is_influencer, type:"select", selectedIndex: -1,items: influencerOrProspectItems, valueField: "Value", textField: "Name", validate: {validator:"required", message: influencerFieldsDict.is_influencer+" is required" },  visible: isColumnVisible(influencerFieldsDict.is_influencer)},
                 {title: "Manager",name: "created_by__username", type: "select",  selectedIndex: -1,items: users, valueField: "username", textField: "full_name",filtering: true,inserting: false, editing: false, itemTemplate: function(value,item){
                     return item.created_by__first_name +" "+ item.created_by__last_name; }, visible: isColumnVisible(influencerFieldsDict.created_by_id) },
                 {name: "date_of_promotion_on", title: influencerFieldsDict.date_of_promotion_on, type: "myDateField",  align: "center", inserting: true, editing: true, autosearch: true,filtering:true, visible: isColumnVisible(influencerFieldsDict.date_of_promotion_on) },
                 {name: "paid_or_unpaid", title: influencerFieldsDict.paid_or_unpaid, type:"select", items: paid_unpaid_choices ,textField:"Name", valueField: "Name", visible: isColumnVisible(influencerFieldsDict.paid_or_unpaid) },
                 {name: "channel_username", title: influencerFieldsDict.channel_username, type: "text", visible: isColumnVisible(influencerFieldsDict.channel_username)},
                 {name: "followers_count", title: influencerFieldsDict.followers_count, type: "number", visible: isColumnVisible(influencerFieldsDict.followers_count)},

                 {name: "email", title: influencerFieldsDict.email, type: "text", visible: isColumnVisible(influencerFieldsDict.email) },
                 {name: "country", title: influencerFieldsDict.country, type: "select",  items: list_of_countries, selectedIndex: -1, textField:"Name", valueField: "Name", validate: "required", visible:isColumnVisible(influencerFieldsDict.country) },
                 {name: "channel", title: influencerFieldsDict.channel, type: "select", selectedIndex: -1, items: channels, textField:"Name", valueField: "Name", visible: isColumnVisible(influencerFieldsDict.channel)},
                 {name: "discount_coupon", title: influencerFieldsDict.discount_coupon, type: "text", visible: isColumnVisible(influencerFieldsDict.discount_coupon)},
                 {name: "valid_from", title: influencerFieldsDict.valid_from, type: "myDateField",  align: "center",inserting: false, editing: false, autosearch: true,filtering:true, visible: isColumnVisible(influencerFieldsDict.valid_from) },
                 {name: "valid_till", title: influencerFieldsDict.valid_till, type: "myDateField",  align: "center",inserting:false, editing: false, autosearch: true,filtering:true, visible: isColumnVisible(influencerFieldsDict.valid_till) },
                 {name: "status", title: influencerFieldsDict.status, type: "select", selectedIndex: -1, items: influencer_post_status,textField:"Name", valueField: "Name", visible: isColumnVisible(influencerFieldsDict.status)},
                 {name: "order_code", title: influencerFieldsDict.order_code, type:"text", visible: isColumnVisible(influencerFieldsDict.order_code) },
                 {name: "order_num", title: influencerFieldsDict.order_num,  type: "text", visible: isColumnVisible(influencerFieldsDict.order_num) },
                 {name: "influencer_name", title: influencerFieldsDict.influencer_name, type: "text", required: true, visible: isColumnVisible(influencerFieldsDict.influencer_name) },
                 {name: "collection", title: influencerFieldsDict.collection, type: "select", selectedIndex: -1, items: collections, textField:"Name", valueField: "Name", visible: isColumnVisible(influencerFieldsDict.collection) },
                 {name: "commission", title: influencerFieldsDict.commission, type: "number", filtering: false, visible: isColumnVisible(influencerFieldsDict.commission)},
                 {name: "product_cost", title: influencerFieldsDict.product_cost,  type: "number", filtering: false,  visible: isColumnVisible(influencerFieldsDict.product_cost) },
                 {name: "revenue_click", title: influencerFieldsDict.revenue_click, type: "number", editing: false,inserting: false, itemTemplate: function(value,item){ return value && Math.round(value*100)/100; },visible: isColumnVisible(influencerFieldsDict.revenue_click)  },
                 {name: "comments", title: influencerFieldsDict.comments, type: "textarea",align: "right", inserting: true, editing: true, visible: isColumnVisible(influencerFieldsDict.comments) },
                 {name: "created_at", title: influencerFieldsDict.created_at, type: "myDateField",  align: "center",  inserting: false, editing: false,autosearch: true,filtering:true,itemTemplate: function(value) {
                    var x = new Date(value);
                    return x.toLocaleDateString("fr-CA")+" "+x.getHours()+":"+x.getMinutes()+":"+x.getSeconds();
                } ,visible: isColumnVisible(influencerFieldsDict.created_at)  },

                 {name: "updated_by__username", title: "Last Updated By", type:"text", visible:true,inserting: false, editing: false, textField: "updated_by__username", valueField: "updated_by", itemTemplate:function(value,item){
                  return item.updated_by__first_name +" "+ item.updated_by__last_name;
                 },visible: isColumnVisible(influencerFieldsDict.updated_by__username)  },
                 {name: "updated_at", title: influencerFieldsDict.updated_at, type: "myDateField",  align: "center",  inserting: false, editing: false,autosearch: true,filtering:true, itemTemplate: function(value) {
                    var x = new Date(value);
                    return x.toLocaleDateString("fr-CA")+" "+x.getHours()+":"+x.getMinutes()+":"+x.getSeconds();
                } , visible: isColumnVisible(influencerFieldsDict.updated_at)  },
                {name: "centra_update_at", title: influencerFieldsDict.centra_update_at, type: "myDateField",  align: "center",  inserting: false, editing: false,autosearch: true,filtering:true, itemTemplate: function(value) {
                    if(!value) return "";
                    var x = new Date(value);
                    return x.toLocaleDateString("fr-CA")+" "+x.getHours()+":"+x.getMinutes()+":"+x.getSeconds();
                }, visible: isColumnVisible(influencerFieldsDict.centra_update_at) },

                 {name: "is_answered", title: influencerFieldsDict.is_answered, type: "select", items: is_answered_choices, valueField: "Name", textField: "Name",  visible: isColumnVisible(influencerFieldsDict.is_answered)  },
                 {name: "last_contacted_on", title: influencerFieldsDict.last_contacted_on ,type: "myDateField",  align: "center",  inserting: true, editing: true,autosearch: true,filtering:true , visible: isColumnVisible(influencerFieldsDict.last_contacted_on)},
                 {name: "", title: influencerFieldsDict.is_duplicate, type: "checkbox", visible: true, inserting: true, editing: true, visible: isColumnVisible(influencerFieldsDict.is_duplicate) },
                 {name: "is_old_record", type: "checkbox", title:influencerFieldsDict.is_old_record, visible: true, inserting: true, editing: true,  visible: isColumnVisible(influencerFieldsDict.is_old_record)},
                 {type: "control" }
             ]

             });


          var selectedItems = [];

          var selectItem = function(item) {
              selectedItems.push(item);
          };

          var unselectItem = function(item) {
              selectedItems = $.grep(selectedItems, function(i) {
                  return i !== item;
              });
          };

          var deleteSelectedItems = function() {
              if(!selectedItems.length || !confirm("Are you sure?"))
                  return;
              selectedIds = selectedItems.map((x)=>x.id);
              //console.log("selected ids {selectedIds}" );
              return $.ajax({
                     type: "DELETE",
                     url: "influencers",
                     data: JSON.stringify(selectedIds),
                     headers: {"X-CSRFToken": '{{ csrf_token }}', "content-type":"text/json"},
                     error:function(response){
                         if(response.responseJSON){
                              alert(response.responseJSON.error+" "+response.statusText);
                           }else{
                              alert(response.statusText);
                           }
                         selectedItems = [];
                     },
                     success: function(response){
                         alert(response);
                         selectedItems = [];
                         loadGrid($("#jsGridInfluencers"));
                     }
                 });


           $("table").each(function(){$(this).stickyTableHeaders();});

          };



    $('#influencers').submit(function(e){
      e.preventDefault();
      var form = $(this);
      var files = form[0][0].files;
      if(files.length < 1){
        alert("Please select csv file");
        return;
      }
       if(files[0].name.split(".").pop() != "csv"){
           alert("Please select csv file only");
           return;
       }
       form[0][2].disabled=true;
       $(".showUploading").attr("id","status");
       $.ajax({
           data: new FormData(form[0]),
           processData: false,
           contentType: false,
           url: form.attr('action'),
           method: form.attr('method'),
           success: function(response){
               var duplicates = response.duplicates;
               var createdCount = response.createdCount;
               //console.log("after succes");
               if(duplicates && duplicates.length > 0){
                /*
                   create modal window ,and pass leads created number till now.
                   let model window be submitted, with labels of data and radio buttons.
                   Once the window is submitted, as the response of the submission,
                   once that is submitted , put the final count into view.

                */
                form[0][2].disabled=false;
                form[0].reset();


               }else{
                   alert(createdCount+" Record(s) have been created");
                   loadGrid($('#jsGridInfluencers'));

               }
           },
           error: function(response){
               if(response.responseJSON){
                  alert(response.responseJSON.error+" "+response.statusText);
               }else{
                  alert(response.statusText);
               }

           },

           complete: function(data){
               form[0][2].disabled=false;
               form[0].reset();
               $(".showUploading").attr("id","");
           }
       });

});

      menuList = $("a[href='#importFunction'] , a[href='#all_influencers']");
       menuList.each(function(){
         if(this.hash != "#all_influencers"){
            $(this.hash).hide();
         }
       });
       menuList.click(function(e){
                e.preventDefault();
                hashValue = this.hash;

           menuList.each(function(){
            if(this.hash == hashValue){
               if(hashValue == "#all_influencers" && $(this).parent().hasClass("active")){
                  window.open("/");
               }else{
                  $(this.hash).show();
                  $(this).parent().addClass("active");
               }

            }else{
               $(this.hash).hide();
               $(this).parent().removeClass("active");
            }
           });

        });

        });
     </script>
   </body>
</html>
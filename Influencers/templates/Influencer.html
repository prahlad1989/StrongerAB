<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>Influencers</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- site icons -->
      <link rel="icon" href="static/images/fevicon/1234.png" type="image/png" />
      <!-- bootstrap css -->
      <link rel="stylesheet" href="static/css/bootstrap.min.css" />
      <!-- site css -->
      <link rel="stylesheet" href="static/css/style.css" />
      <link rel="stylesheet" href="https://forni.se/wp-content/themes/sw_new_forni_theme/css/crm.css" />
      <!-- responsive css -->
      <link rel="stylesheet" href="static/css/responsive.css" />
      <!-- colors css -->
      <link rel="stylesheet" href="static/css/colors.css" />
      <!-- wow animation css -->
      <link rel="stylesheet" href="static/css/animate.css" />
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <![endif]-->
   </head>

   <body id="default_theme" class="home_page1" >
   <script>
       var is_user_staff='{{ is_user_staff }}'=='True';
       var influencerFieldsDict = {{ influencerFieldsDict |safe }};
       var dropDownFunction = function(x){return {Name:x}} ;
       var list_of_countries = '{{ list_of_countries }}'
       list_of_countries = list_of_countries.split(",").map(dropDownFunction);
       var collections = '{{collections}}'
       collections = collections.split(",").map(dropDownFunction);
       var channels = '{{channels}}'
       //console.log(channels);
       channels = channels.split(",").map(dropDownFunction);
       //console.log(channels);
       var influencer_post_status = {{ influencer_post_status| safe }}
       influencer_post_status = influencer_post_status.map(dropDownFunction);
       var paid_unpaid_choices = {{ paid_unpaid_choices| safe }}
       //console.log(paid_unpaid_choices);
       paid_unpaid_choices = paid_unpaid_choices.map(dropDownFunction);
       //console.log(paid_unpaid_choices);
       var influencerOrProspectItems = {{ is_influencer_choices|safe }}
       influencerOrProspectItems = influencerOrProspectItems.map(dropDownFunction);
       var is_answered_choices = {{ is_answered_choices |safe }};
       is_answered_choices = is_answered_choices.map(dropDownFunction);
       //console.log("influencer_post_status "+influencer_post_status);

       function loadGrid($grid){
           $grid.jsGrid("option","pageIndex",1);
           $grid.jsGrid("loadData");
       }

   </script>
      <!-- header -->
      <header class="header header_style1">
         <div class="container">
            <div class="row">
               <div class="col-md-9 col-lg-10" style="max-height:160px">
                  <div class="logo"><a href="/"><img src="static/images/influencer_logo.png" alt="#" /></a></div>
                  <div class="main_menu float-right">
                     <div class="menu">
                        <ul class="clearfix">
                           <li class="active"><a href="#all_influencers">Influencers</a></li>
                           <li><a href="reports.html">Reports</a></li>
                           <li><a href="#importFunction">Upload</a></li>
                           <li><a href="admin" target="_blank">Admin</a></li>
                           <li><a href="change-password">Change Pwd</a></li>
                           <li><a href="logout">LogOut</a></li>
                           <li>Hi {{first_name}}</li>

                        </ul>
                     </div>
                  </div>

               </div>
               <!--<div class="col-md-3 col-lg-2">
                  <div class="right_bt"><div class="bt_main" href="index.html">Prahlad/LogOut</div> </div>
               </div>-->
            </div>
         </div>
      </header>


      <!-- section -->
      <section class="layout_padding layer_style" id="all_influencers">

         <!--<div id="jsGrid3" ></div>-->
         <br><br>
         <div id="jsGridInfluencers"></div>

      </section>

      <section class="layout_padding layer_style" id="importFunction">

         <!--<div id="jsGrid3" ></div>-->
         <br><br>
         <div class="container text_align_center" >
            <div class="notice">Please upload csv file with the format similar to <a href="https://docs.google.com/spreadsheets/d/1YOWGGTQytCGnUJzWrpvG6A4a6CFYbiGh26TTR65Vj2E/edit#gid=300405385" target="_blank">here</a></div>
            <br>
            <div name="uploads">

               <form action="influencers" id="influencers" method="post" enctype="multipart/form-data">
                   <input type="file" id="myfile" name="myfile"/>
                   {% csrf_token %}
                   <input type="submit"   value="Upload">
               </form>
            </div>
         </div>
      </section>
      <!-- jQuery (necessary for Bootstrap's JavaScript) -->
      <script src="static/js/jquery.min.js"></script>
      <script src="static/js/popper.min.js"></script>
      <script src="static/js/bootstrap.min.js"></script>
      <script src="static/js/owl.carousel.js"></script>
      <!-- wow animation -->
      <script src="static/js/wow.js"></script>

      <!-- custom js -->
      <script src="static/js/custom.js"></script>
       <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.2/themes/cupertino/jquery-ui.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>

      <script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/src/js/bootstrap-datetimepicker.js"></script>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/build/css/bootstrap-datetimepicker.css">
      <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
      <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
      <script src=" http://benalman.com/code/projects/jquery-throttle-debounce/jquery.ba-throttle-debounce.js"></script>
      <!-- google map js -->

      <script src="static/js/db.js"></script>



      <!-- end google map js -->
     <script>

      $(function() {
            var originalFilterTemplate = jsGrid.fields.text.prototype.filterTemplate;
                        //console.log(originalFilterTemplate);
            jsGrid.fields.text.prototype.filterTemplate = function() {
                        var grid = this._grid;
                        if(!this.filtering)
                           return originalFilterTemplate;
                        var $result = originalFilterTemplate.call(this);
                        $result.on("keyup", $.debounce(350, function(e){
                           grid.search();
                        }));
                        return $result;
                    }

            function MyDateField(config) {
            jsGrid.Field.call(this, config);
        };

            MyDateField.prototype = new jsGrid.Field({
                sorter: function(date1, date2) {
                    return new Date(date1) - new Date(date2);
                },
                _createDate: function($grid){
                    return  $("<input>").datepicker({
                    defaultDate: new Date(),
                    dateFormat: 'dd/mm/yy',
                    onSelect: function(dateText) {
                            $grid.search();
    }                }).prop("readonly", !!this.readOnly);
                },
                filterTemplate: function() {
                    if(!this.filtering)
                    return "";
                    var grid = this._grid,
                    $result = this.filterControl = this._createDate(this._grid);
                    return $result;
                },
            filterValue: function() {
                var date=this.filterControl.datepicker("getDate");
                if(date) return (date.getTime())/1000;
                return null;
            },

                itemTemplate: function(value) {
                    return value && new Date(value).toLocaleDateString();
                },
                insertTemplate: function(value) {
                    if(!this.inserting)
                        return "";
                    return this._insertPicker = $("<input>").datepicker({ defaultDate: new Date() });
                },
                editTemplate: function(value) {
                    if(!this.editing)
                        return this.itemTemplate.apply(this, arguments);
                     if(!value)return this._insertPicker = $("<input>").datepicker({ defaultDate: new Date() });
                     return this._editPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));
                },
                insertValue: function() {
                    var date=this._insertPicker.datepicker("getDate");
                    if(date) return date.toLocaleDateString();
                    return null;
                },
                editValue: function() {
                    var date=this._editPicker.datepicker("getDate");
                    if(date) return (date.getTime())/1000;
                    return null;
                }
            });

            jsGrid.fields.myDateField = MyDateField;

           /* function insert_on_enter(field) {
              field.on("keydown", function(e) {
                if(e.keyCode === 13) {
                  $("#jsGridInfluencers").jsGrid("insertItem");
                  return false;
                }
              });
            }

            function update_on_enter(field) {
              field.on("keydown", function(e) {
                if(e.keyCode === 13) {
                  $("#jsGridInfluencers").jsGrid("updateItem");
                  return false;
                }
              });
            } */


            $("#jsGridInfluencers").jsGrid({
             width:"250%",
             inserting:true,
             editing:true,
             sorting:true,
             paging:true,
             pageSize:100,
             autoload: true,
             filtering:true,
             autoSearch:true,
             pageLoading: true,

             pagerFormat: "Pages: {first} {prev} {pages} {next} {last} &nbsp;&nbsp; {pageIndex} of {pageCount} &nbsp;&nbsp; Records Shown: {itemCount}",
             controller: {
             insertItem: function(item) {
                 var grid=this._grid;
                 return $.ajax({
                     type: "POST",
                     url: "influencer",
                     data: item,
                     headers:{"X-CSRFToken": '{{ csrf_token }}'},
                     error: function (data){
                         alert(data.statusText);
                     },
                     success: function(data){
                         grid.jsGrid("option","pageIndex",1);
                         grid.jsGrid("loadData");
                     },
                      error:function(data){
                         alert(data.statusText);
                     },
                 });
             },

             deleteItem: function(item) {
                 var $grid = $(this);
                 return $.ajax({
                     type: "DELETE",
                     url: "influencer",
                     data: JSON.stringify(item),
                     headers: {"X-CSRFToken": '{{ csrf_token }}', "content-type":"text/json"},
                     error:function(data){
                         alert(data.responseJSON.error);
                     },
                     success: function(data){
                         alert("Deleted");
                     }
                 });
             },
             onItemInserted:function(args){
                 $("#jsGrid").jsGrid("loadData");
             }
             ,
             updateItem: function(item) {
                 return $.ajax({
                     type: "PUT",
                     url: "influencer",
                     data: JSON.stringify(item),
                     headers:{"X-CSRFToken": '{{ csrf_token }}',"content-type":"text/json"},
                     error:function(data){
                         if(!data.responseJSON){
                             alert(data.statusText);
                         }
                         else alert(data.responseJSON.error);
                     }
                 });
             },

             loadData: function(filter) {
                                 var d = $.Deferred();
                                 $.ajax({
                                     url: "influencers_query",
                                     dataType: "json",
                                     data:JSON.stringify(filter),
                                     method:"POST",
                                     headers:{"X-CSRFToken": '{{ csrf_token }}',"content-type":"text/json"},

                                 }).done(function(response) {
                                         var records=response.data;
                                         records.forEach(function(record,index){
                                             record.index = index+1;
                                         });
                                      d.resolve(response);
                                 });
                                 return d.promise();
                             }
                         },

             fields: [
                 {title: "Id", name: "id", type: "number", visible: false, inserting: false, editing: false },
                 //{title: "SN", width:40, name: "index", type: "number", visible: true, inserting: false, editing: false , align: "center", filtering:false },
                 {name: "is_influencer", title: influencerFieldsDict.is_influencer, type:"select", selectedIndex: -1,items: influencerOrProspectItems, valueField: "Name", textField: "Name", validate: {validator:"required", message: influencerFieldsDict.is_influencer+" is required" }},
                 {title: "Manager",name: "created_by__username", type: "text", valueField: "created_by", textField: "created_by__username",filtering: true,inserting: false, editing: false, itemTemplate: function(value,item){
                     return item.created_by__first_name +" "+ item.created_by__last_name; } },

                 {name: "email", title: influencerFieldsDict.email, type: "text", validate: "required", validate:
                  {
                     validator: function(value, item){
                         var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                         return regex.test(value);
                     },
                     message:"Please enter valid email."
                 }},

                 {name: "is_answered", title: influencerFieldsDict.is_answered, type: "select", items: is_answered_choices, valueField: "Name", textField: "Name" },
                 {name: "last_contacted_on", title: influencerFieldsDict.last_contacted_on ,type: "myDateField",  align: "center",  inserting: true, editing: true,autosearch: true,filtering:true },
                 {name: "is_duplicate", title: influencerFieldsDict.is_duplicate, type: "checkbox", visible: true, inserting: true, editing: true},
                 {name: "order_num", title: influencerFieldsDict.order_num,  type: "text" },
                 {name: "order_code", title: influencerFieldsDict.order_code, type:"text" },
                 {name: "date_of_promotion_on", title: influencerFieldsDict.date_of_promotion_on, type: "myDateField",  align: "center", inserting: true, editing: true, autosearch: true,filtering:true },
                 {name: "influencer_name", title: influencerFieldsDict.influencer_name, type: "text", required: true },
                 {name: "paid_or_unpaid", title: influencerFieldsDict.paid_or_unpaid, type:"select", items: paid_unpaid_choices ,textField:"Name", valueField: "Name" },
                 {name: "channel_username", title: influencerFieldsDict.channel_username, type: "text"},
                 {name: "followers_count", title: influencerFieldsDict.followers_count, type: "number"},
                 {name: "country", title: influencerFieldsDict.country, type: "select",  items: list_of_countries, selectedIndex: -1, textField:"Name", valueField: "Name", validate: "required" },
                 {name: "collection", title: influencerFieldsDict.collection, type: "select", selectedIndex: -1, items: collections, textField:"Name", valueField: "Name" },
                 {name: "channel", title: influencerFieldsDict.channel, type: "select", selectedIndex: -1, items: channels, textField:"Name", valueField: "Name"},
                 {name: "discount_coupon", title: influencerFieldsDict.discount_coupon, type: "text"},
                 {name: "valid_from", title: influencerFieldsDict.valid_from, type: "myDateField",  align: "center",inserting: false, editing: false, autosearch: true,filtering:true },
                 {name: "valid_till", title: influencerFieldsDict.valid_till, type: "myDateField",  align: "center",inserting:false, editing: false, autosearch: true,filtering:true },
                 {name: "status", title: influencerFieldsDict.status, type: "select", selectedIndex: -1, items: influencer_post_status,textField:"Name", valueField: "Name" },
                 {name: "commission", title: influencerFieldsDict.commission, type: "number", filtering: false},
                 {name: "product_cost", title: influencerFieldsDict.product_cost,  type: "number", filtering: false},
                 {name: "revenue_click", title: influencerFieldsDict.revenue_click, type: "number", editing: false,inserting: false },
                 {name: "comments", title: influencerFieldsDict.comments, type: "textarea",align: "right", inserting: true, editing: true},
                 {name: "created_at", title: influencerFieldsDict.created_at, type: "text",  align: "center",  inserting: false, editing: false,autosearch: true,filtering:true },

                 {name: "updated_by__username", title: "Last Updated By", type:"number", visible:true,inserting: false, editing: false, textField: "updated_by__username", valueField: "updated_by", itemTemplate:function(value,item){
                  return item.updated_by__first_name +" "+ item.updated_by__last_name;
                 } },
                 {name: "updated_at", title: influencerFieldsDict.updated_at, type: "text",  align: "center",  inserting: false, editing: false,autosearch: true,filtering:true },

                 {type: "control" }
             ]

             });

    $('#influencers').submit(function(e){
      e.preventDefault();
      var form = $(this);
      var files = form[0][0].files;
      if(files.length < 1){
        alert("Please select csv file");
        return;
      }
       if(files[0].name.split(".").pop() != "csv"){
           alert("Please select csv file only");
           return;
       }
       form[0][2].disabled=true;
       form.parent().attr("id", "status");
       $.ajax({
           data: new FormData(form[0]),
           processData: false,
           contentType: false,
           url: form.attr('action'),
           method: form.attr('method'),
           success: function(response){
               var duplicates = response.duplicates;
               var createdCount = response.createdCount;
               console.log("after succes");
               if(duplicates && duplicates.length > 0){
                /*
                   create modal window ,and pass leads created number till now.
                   let model window be submitted, with labels of data and radio buttons.
                   Once the window is submitted, as the response of the submission,
                   once that is submitted , put the final count into view.

                */
                form[0][2].disabled=false;
                form[0].reset();


               }else{
                   alert(createdCount+" Record(s) have been created");
                   loadGrid($('#jsGridInfluencers'));

               }
           },
           error: function(response){
               if(response.responseJSON){
                  alert(response.responseJSON.error);
               }else{
                  alert(response.statusText);
               }

           },

           complete: function(data){
               form[0][2].disabled=false;
               form[0].reset();
               form.parent().attr("id", "");
           }
       });

});

      menuList = $("a[href='#importFunction'] , a[href='#all_influencers']");
       menuList.each(function(){
         if(this.hash != "#all_influencers"){
            $(this.hash).hide();
         }
       });

       menuList.click(function(e){
                e.preventDefault();
                hashValue = this.hash;
           menuList.each(function(){
            if(this.hash == hashValue){
               $(this.hash).show();
               $(this).parent().addClass("active");
            }else{
               $(this.hash).hide();
               $(this).parent().removeClass("active");
            }
           });
           /*if(this.hash == "#importFunction"){
            $("#all_influencers").hide();
            $("#importFunction").show();
           }
           else if(this.hash == "#all_influencers" || this.hash == "#file_upload_b2b"){
            $("#importFunction").hide();
             $("#all_influencers").show();
           }
           $('html,body').animate({scrollTop: $(this.hash).offset().top-100},'slow'); */
        });

        });
     </script>
   </body>
</html>